<!DOCTYPE html>
<html>
<head>
    <title>Démo Cognex - IUT GEII</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.2.8/mqtt.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .logo {
            width: 150px;
            margin: 20px auto;
        }
        .result-container {
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .result-box {
            font-size: 2em;
            width: 250px;
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Résultat du Comptage</h1>

    <!-- Affichage du logo -->
    <img src="images/logo-uha.png" alt="Logo Démo IOT" class="logo">

    <!-- Affichage des résultats pour chaque caméra -->
    <div class="result-container">
        <div id="result_7802" class="result-box" style="background-color: gray;">
            7802 : En attente...
        </div>
        <div id="result_7802C" class="result-box" style="background-color: gray;">
            7802C : En attente...
        </div>
    </div>

    <script>
        // Connexion au broker MQTT public
        const client = mqtt.connect("wss://test.mosquitto.org:8081/mqtt");

        // Déterminer la caméra sélectionnée en fonction de l'URL du QR Code
        const urlParams = new URLSearchParams(window.location.search);
        const cameraTopic = urlParams.get('cam');  // "geii_7802" ou "geii_7802C"

        if (cameraTopic) {
            console.log("Caméra sélectionnée :", cameraTopic);
            
            // Envoi de la trame SNAP au bon topic MQTT
            client.on("connect", function () {
                client.publish(cameraTopic, "snap");
                console.log("Commande envoyée à :", cameraTopic);
            });
        }

        // S'abonner aux messages des résultats
        client.subscribe("geii_result");

        // Réception des messages MQTT
        client.on("message", function (topic, message) {
            let msg = message.toString();
            console.log(`Message reçu sur ${topic} :`, msg);

            if (topic === "geii_result") {
                try {
                    let data = JSON.parse(msg);  // Conversion JSON
                    let comptage = parseInt(data.comptage);
                    let seuil = parseInt(data.seuil);
                    let camera = data.camera; // Déterminer la caméra source

                    // Sélectionner le bon affichage en fonction de la caméra
                    let resultDiv = document.getElementById(`result_${camera}`);

                    if (resultDiv) {
                        resultDiv.innerText = `${camera} : ${comptage} / Seuil : ${seuil}`;
                        
                        // Changer la couleur selon le seuil
                        if (comptage > seuil) {
                            resultDiv.style.backgroundColor = "red";
                        } else {
                            resultDiv.style.backgroundColor = "green";
                        }
                    }
                } catch (e) {
                    console.error("Erreur JSON :", e);
                }
            }
        });
    </script>
</body>
</html>
